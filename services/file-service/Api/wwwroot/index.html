<!doctype html>
<html lang="no">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Jobbmarked - Min Profil</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container">
      <div class="card" id="mainCard">
        <div id="login" class="form-section active">
          <h2>Velkommen tilbake</h2>
          <form onsubmit="handleAuth(event, '/Auth/login', 'login')">
            <div class="input-group">
              <label>E-postadresse</label>
              <input
                type="email"
                name="email"
                required
                placeholder="ivankalyta@gmail.com"
              />
            </div>
            <div class="input-group">
              <label>Passord</label>
              <input type="password" name="password" required />
            </div>
            <button type="submit" class="primary-btn">Logg inn</button>
          </form>
          <div class="toggle-links">
            <p>
              Ny bruker?
              <span class="link" onclick="showSection('register')"
                >Opprett konto</span
              >
            </p>
          </div>
        </div>

        <div id="register" class="form-section">
          <h2>Opprett konto</h2>
          <form onsubmit="handleAuth(event, '/Auth/register', 'register')">
            <div class="input-group">
              <label>E-postadresse</label>
              <input
                type="email"
                name="email"
                required
                placeholder="ivankalyta@gmail.com"
              />
            </div>
            <div class="input-group">
              <label>Passord</label>
              <input
                type="password"
                name="password"
                required
                placeholder="Minst 6 tegn"
              />
            </div>
            <button type="submit" class="primary-btn">Registrer deg</button>
          </form>
          <div class="toggle-links">
            <span class="link" onclick="showSection('login')"
              >Har du allerede konto?</span
            >
          </div>
        </div>

        <div id="profile-view" class="form-section">
          <h2>Min Profil</h2>
          <div class="profile-display">
            <img
              id="displayAvatar"
              src="https://via.placeholder.com/150"
              class="avatar-preview"
            />
            <div class="info-group">
              <p>
                <strong>Navn:</strong>
                <span id="displayFullName">Ikke satt</span>
              </p>
            </div>
          </div>
          <button class="primary-btn" onclick="showSection('profile')">
            Rediger profil
          </button>
          <div class="toggle-links">
            <span class="link" onclick="showSection('change-password')"
              >Bytt passord</span
            >
            <span class="link" onclick="showSection('login')">Logg ut</span>
          </div>
        </div>

        <div id="profile" class="form-section">
          <h2>Rediger Profil</h2>
          <form onsubmit="handleProfileUpdate(event)">
            <div class="avatar-upload">
              <img
                id="avatarPreview"
                src="https://via.placeholder.com/150"
                class="avatar-preview"
              />
              <label for="avatarInput" class="upload-btn">Endre bilde</label>
              <input
                type="file"
                id="avatarInput"
                name="AvatarFile"
                class="file-input"
                accept="image/*"
                onchange="previewImage(this)"
              />
            </div>
            <div class="form-row">
              <div class="input-group" style="flex: 1">
                <label>Fornavn</label>
                <input
                  type="text"
                  id="editFirstName"
                  name="FirstName"
                  placeholder="Ola"
                  required
                />
              </div>
              <div class="input-group" style="flex: 1">
                <label>Etternavn</label>
                <input
                  type="text"
                  id="editLastName"
                  name="LastName"
                  placeholder="Nordmann"
                  required
                />
              </div>
            </div>
            <button type="submit" class="primary-btn">Lagre profil</button>
          </form>
          <div class="toggle-links">
            <span class="link" onclick="showSection('profile-view')"
              >Avbryt</span
            >
          </div>
        </div>

        <div id="change-password" class="form-section">
          <h2>Bytt passord</h2>
          <form
            onsubmit="
              handleAuth(event, '/Auth/change-password', 'change-password')
            "
          >
            <div class="input-group">
              <label>E-postadresse</label>
              <input
                type="email"
                name="email"
                required
                placeholder="ivankalyta@gmail.com"
              />
            </div>
            <div class="input-group">
              <label>Gammelt passord</label>
              <input type="password" name="oldPassword" required />
            </div>
            <div class="input-group">
              <label>Nytt passord</label>
              <input
                type="password"
                name="newPassword"
                required
                placeholder="Minst 6 tegn"
              />
            </div>
            <button type="submit" class="primary-btn">Oppdater passord</button>
          </form>
          <div class="toggle-links">
            <span class="link" onclick="showSection('profile-view')"
              >Tilbake</span
            >
          </div>
        </div>
      </div>
    </div>

    <script>
      function showSection(id) {
        document
          .querySelectorAll(".form-section")
          .forEach((el) => el.classList.remove("active"));
        document.getElementById(id).classList.add("active");

        if (id === "login") {
          localStorage.removeItem("token");
        }
      }

      function previewImage(input) {
        if (input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = (e) =>
            (document.getElementById("avatarPreview").src = e.target.result);
          reader.readAsDataURL(input.files[0]);
        }
      }

      async function loadProfileData() {
        const token = localStorage.getItem("token");
        if (!token) return;

        try {
          const response = await fetch("/api/Profile", {
            method: "GET",
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (response.ok) {
            const result = await response.json();
            const profile = result.data || result;

            if (profile) {
              document.getElementById("displayFullName").innerText =
                `${profile.firstName} ${profile.lastName}`;
              document.getElementById("editFirstName").value =
                profile.firstName || "";
              document.getElementById("editLastName").value =
                profile.lastName || "";

              if (profile.avatarUrl) {
                document.getElementById("displayAvatar").src =
                  profile.avatarUrl;
                document.getElementById("avatarPreview").src =
                  profile.avatarUrl;
              }

              showSection("profile-view");
            }
          } else if (response.status === 401) {
            showSection("login");
          }
        } catch (e) {
          console.error("Profile load failed:", e);
        }
      }

      async function handleAuth(event, url, type) {
        event.preventDefault();
        const data = Object.fromEntries(new FormData(event.target).entries());

        try {
          const response = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });

          const result = await response.json();
          const token = result.token || result.Token;

          if (response.ok) {
            if (token) {
              localStorage.setItem("token", token);
              await loadProfileData();
            } else if (type === "register") {
              showSection("login");
            } else if (type === "change-password") {
              alert("Passord er endret!");
              showSection("profile-view");
            }
          } else {
            alert(result.error || result.message || "Noe gikk galt");
          }
        } catch (e) {
          alert("Serverfeil");
        }
      }

      async function handleProfileUpdate(event) {
        event.preventDefault();
        const token = localStorage.getItem("token");

        if (!token) {
          showSection("login");
          return;
        }

        const formData = new FormData(event.target);
        const btn = event.target.querySelector("button");
        btn.innerText = "Lagrer...";

        try {
          const response = await fetch("/api/Profile", {
            method: "POST",
            headers: {
              Authorization: `Bearer ${token}`,
            },
            body: formData,
          });

          if (response.ok) {
            await loadProfileData();
          } else if (response.status === 401) {
            showSection("login");
          } else {
            alert("Kunne ikke lagre profil.");
          }
        } catch (error) {
          alert("Serverfeil.");
        } finally {
          btn.innerText = "Lagre profil";
        }
      }

      window.onload = () => {
        const token = localStorage.getItem("token");
        if (token) {
          loadProfileData();
        }
      };
    </script>
  </body>
</html>
