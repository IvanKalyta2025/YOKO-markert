<!doctype html>
<html lang="no">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Jobbmarked - Min Profil</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container">
      <div class="card" id="mainCard">
        <div id="login" class="form-section active">
          <h2>Velkommen tilbake</h2>
          <form onsubmit="handleAuth(event, '/Auth/login', 'login')">
            <div class="input-group">
              <label>E-postadresse</label>
              <input
                type="email"
                name="email"
                required
                placeholder="ola@eksempel.no"
              />
            </div>
            <div class="input-group">
              <label>Passord</label>
              <input type="password" name="password" required />
            </div>
            <button type="submit" class="primary-btn">Logg inn</button>
          </form>
          <div class="toggle-links">
            <p>
              Ny bruker?
              <span class="link" onclick="showSection('register')"
                >Opprett konto</span
              >
            </p>
          </div>
        </div>

        <div id="register" class="form-section">
          <h2>Opprett konto</h2>
          <form onsubmit="handleAuth(event, '/Auth/register', 'register')">
            <div class="input-group">
              <label>E-postadresse</label>
              <input
                type="email"
                name="email"
                required
                placeholder="ola@eksempel.no"
              />
            </div>
            <div class="input-group">
              <label>Passord</label>
              <input
                type="password"
                name="password"
                required
                placeholder="Minst 6 tegn"
              />
            </div>
            <button type="submit" class="primary-btn">Registrer deg</button>
          </form>
          <div class="toggle-links">
            <span class="link" onclick="showSection('login')"
              >Har du allerede konto?</span
            >
          </div>
        </div>

        <div id="profile" class="form-section">
          <h2>Min Profil</h2>
          <form onsubmit="handleProfileUpdate(event)">
            <div class="avatar-upload">
              <img
                id="avatarPreview"
                src="https://via.placeholder.com/150"
                class="avatar-preview"
              />

              <label for="avatarInput" class="upload-btn">üì∑ Endre bilde</label>
              <input
                type="file"
                id="avatarInput"
                name="AvatarFile"
                class="file-input"
                accept="image/*"
                onchange="previewImage(this)"
              />
            </div>

            <div class="form-row">
              <div class="input-group" style="flex: 1">
                <label>Fornavn</label>
                <input
                  type="text"
                  name="FirstName"
                  placeholder="Ola"
                  required
                />
              </div>
              <div class="input-group" style="flex: 1">
                <label>Etternavn</label>
                <input
                  type="text"
                  name="LastName"
                  placeholder="Nordmann"
                  required
                />
              </div>
            </div>

            <button type="submit" class="primary-btn">Lagre profil</button>
          </form>

          <div class="toggle-links">
            <span class="link" onclick="showSection('login')">Logg ut</span>
          </div>
        </div>

        <div id="feedback" class="visual-feedback">
          <span id="icon" class="icon"></span>
          <h3 id="feedTitle"></h3>
          <p id="feedMessage" style="color: #666"></p>
          <button class="primary-btn" onclick="showSection('profile')">
            Tilbake til profil
          </button>
        </div>
      </div>
    </div>

    <script>
      function showSection(id) {
        document
          .querySelectorAll(".form-section, .visual-feedback")
          .forEach((el) => el.classList.remove("active"));
        document.getElementById("mainCard").className = "card"; // –°–±—Ä–æ—Å —Ü–≤–µ—Ç–æ–≤
        document.getElementById(id).classList.add("active");
      }

      // –ü—Ä–µ–≤—å—é –∫–∞—Ä—Ç–∏–Ω–∫–∏ –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π (—á–∏—Å—Ç—ã–π JS)
      function previewImage(input) {
        if (input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = function (e) {
            document.getElementById("avatarPreview").src = e.target.result;
          };
          reader.readAsDataURL(input.files[0]);
        }
      }

      // –õ–æ–≥–∏–∫–∞ –í—Ö–æ–¥–∞/–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
      async function handleAuth(event, url, type) {
        event.preventDefault();
        const data = Object.fromEntries(new FormData(event.target).entries());

        try {
          const response = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });

          if (response.ok) {
            // –ï–°–õ–ò –£–°–ü–ï–• -> –ò–î–ï–ú –í –ü–†–û–§–ò–õ–¨
            // –¢—É—Ç –≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω—É–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¢–æ–∫–µ–Ω, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
            showSection("profile");

            // –ï—Å–ª–∏ —ç—Ç–æ –±—ã–ª –≤—Ö–æ–¥, –ø–æ–ø—Ä–æ–±—É–µ–º –ø–æ–¥–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è (GET)
            // loadProfileData();
          } else {
            alert("Feil brukernavn eller passord"); // –ü—Ä–æ—Å—Ç–æ–π –∞–ª–µ—Ä—Ç –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏
          }
        } catch (e) {
          console.error(e);
        }
      }

      // –õ–æ–≥–∏–∫–∞ –û–±–Ω–æ–≤–ª–µ–Ω–∏—è –ü—Ä–æ—Ñ–∏–ª—è (–° –§–ê–ô–õ–û–ú)
      async function handleProfileUpdate(event) {
        event.preventDefault();
        const formData = new FormData(event.target); // FormData —Å–∞–º–∞ —Å–æ–±–µ—Ä–µ—Ç —Ñ–∞–π–ª –∏ —Ç–µ–∫—Å—Ç—ã

        const btn = event.target.querySelector("button");
        btn.innerText = "Lagrer..."; // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...

        try {
          // –í–ê–ñ–ù–û: –ù–µ —É–∫–∞–∑—ã–≤–∞–µ–º Content-Type, –±—Ä–∞—É–∑–µ—Ä —Å–∞–º –ø–æ—Å—Ç–∞–≤–∏—Ç multipart/form-data
          const response = await fetch("/api/Profile", {
            method: "POST",
            body: formData,
          });

          if (response.ok) {
            const result = await response.json();

            // –í–∏–∑—É–∞–ª—å–Ω—ã–π —É—Å–ø–µ—Ö
            showSection("feedback");
            document.getElementById("mainCard").classList.add("success-state");
            document.getElementById("icon").innerText = "üéâ";
            document.getElementById("feedTitle").innerText = "Profil Lagret!";
            document.getElementById("feedMessage").innerText =
              "Dine endringer er oppdatert.";

            // –ï—Å–ª–∏ –≤–µ—Ä–Ω—É–ª–∞—Å—å –Ω–æ–≤–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –∞–≤–∞—Ç–∞—Ä, –æ–±–Ω–æ–≤–∏–º –µ—ë
            if (result.data && result.data.avatarUrl) {
              document.getElementById("avatarPreview").src =
                result.data.avatarUrl;
            }
          } else {
            throw new Error("Feil ved lagring");
          }
        } catch (error) {
          alert("Kunne ikke lagre profil. Er du logget inn?");
        } finally {
          btn.innerText = "Lagre profil";
        }
      }
    </script>
  </body>
</html>
