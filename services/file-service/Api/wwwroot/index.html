<!doctype html>
<html lang="no" class="js-loading">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="color-scheme" content="light dark" />
    <title>Jobbmarked - Min Profil</title>

    <!-- Anti-flicker: hide sections until JS decides -->
    <style>
      html.js-loading .form-section {
        display: none !important;
        opacity: 0 !important;
      }
    </style>

    <!-- Inter font -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap"
      rel="stylesheet"
    />

    <!-- Icons -->
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0"
    />

    <link rel="stylesheet" href="style.css" />
  </head>

  <body>
    <div class="background-shape" aria-hidden="true"></div>

    <main class="container">
      <div class="card" id="mainCard">
        <div class="brand-header">
          <h1>Jobbmarked</h1>
          <p>Din karriere starter her</p>
        </div>

        <!-- LOGIN -->
        <section id="login" class="form-section">
          <h2>Velkommen tilbake</h2>

          <form onsubmit="handleAuth(event, '/Auth/login', 'login')">
            <div class="input-group">
              <span class="material-symbols-outlined input-icon">mail</span>
              <input
                type="email"
                name="email"
                required
                placeholder="E-postadresse"
                autocomplete="email"
                inputmode="email"
              />
            </div>

            <div class="input-group">
              <span class="material-symbols-outlined input-icon">lock</span>
              <input
                type="password"
                name="password"
                required
                placeholder="Passord"
                autocomplete="current-password"
              />
            </div>

            <button type="submit" class="primary-btn">Logg inn</button>
          </form>

          <div class="toggle-links">
            <p style="margin: 10px 0 0; text-align: center">
              <span class="link" onclick="prefillEmailToPublicChangePassword()"
                >Endre passord</span
              >
            </p>

            <p style="margin-top: 10px">
              Har du ikke konto?
              <span class="link" onclick="showSection('register')"
                >Opprett ny bruker</span
              >
            </p>
          </div>
        </section>

        <!-- REGISTER -->
        <section id="register" class="form-section">
          <h2>Opprett konto</h2>

          <form onsubmit="handleAuth(event, '/Auth/register', 'register')">
            <div class="input-group">
              <span class="material-symbols-outlined input-icon">mail</span>
              <input
                type="email"
                name="email"
                required
                placeholder="E-postadresse"
                autocomplete="email"
                inputmode="email"
              />
            </div>

            <div class="input-group">
              <span class="material-symbols-outlined input-icon">lock</span>
              <input
                type="password"
                name="password"
                required
                placeholder="Passord"
                autocomplete="new-password"
              />
            </div>

            <button type="submit" class="primary-btn">Registrer deg</button>
          </form>

          <div class="toggle-links">
            <p>
              Har du allerede konto?
              <span class="link" onclick="showSection('login')">Logg inn</span>
            </p>
          </div>
        </section>

        <!-- CHANGE PASSWORD (PUBLIC, BEFORE LOGIN) -->
        <section id="change-password-public" class="form-section">
          <h2>Endre passord</h2>

          <form onsubmit="handleChangePasswordPublic(event)">
            <div class="input-group">
              <span class="material-symbols-outlined input-icon">mail</span>
              <input
                type="email"
                id="cp-email"
                required
                placeholder="E-postadresse"
                autocomplete="email"
                inputmode="email"
              />
            </div>

            <div class="input-group">
              <span class="material-symbols-outlined input-icon">lock</span>
              <input
                type="password"
                id="cp-current-password"
                required
                placeholder="Nåværende passord"
                autocomplete="current-password"
              />
            </div>

            <div class="input-group">
              <span class="material-symbols-outlined input-icon">lock</span>
              <input
                type="password"
                id="cp-new-password"
                required
                placeholder="Nytt passord"
                autocomplete="new-password"
                minlength="6"
              />
            </div>

            <div class="input-group">
              <span class="material-symbols-outlined input-icon">lock</span>
              <input
                type="password"
                id="cp-confirm-password"
                required
                placeholder="Gjenta nytt passord"
                autocomplete="new-password"
                minlength="6"
              />
            </div>

            <div class="button-row">
              <button
                type="button"
                class="outline-btn"
                onclick="showSection('login')"
              >
                Tilbake
              </button>
              <button type="submit" class="primary-btn">Bytt passord</button>
            </div>
          </form>

          <div class="toggle-links" style="margin-top: 10px">
            <p style="text-align: center">
              Du må skrive riktig e-post og nåværende passord.
            </p>
          </div>
        </section>

        <!-- PROFILE VIEW -->
        <section id="profile-view" class="form-section">
          <div class="profile-header">
            <div class="avatar-display">
              <img id="view-avatar" src="default-avatar.png" alt="Avatar" />
            </div>

            <h2 id="view-fullname">Laster...</h2>
            <p class="role-badge">Bruker</p>
          </div>

          <div class="profile-details">
            <div class="profile-detail">
              <span>Alder</span>
              <strong id="view-age">—</strong>
            </div>
            <div class="profile-detail">
              <span>Kjønn</span>
              <strong id="view-gender">—</strong>
            </div>
            <div class="profile-detail">
              <span>Hobby</span>
              <strong id="view-hobby">—</strong>
            </div>
            <div class="profile-detail">
              <span>Fødested</span>
              <strong id="view-birthplace">—</strong>
            </div>
          </div>

          <div class="profile-actions">
            <button class="primary-btn" onclick="showSection('profile-edit')">
              <span class="material-symbols-outlined">edit</span>
              Rediger profil
            </button>

            <button
              class="outline-btn"
              onclick="showSection('change-password')"
            >
              <span class="material-symbols-outlined">lock_reset</span>
              Endre passord
            </button>

            <button class="outline-btn" onclick="logout()">Logg ut</button>
          </div>
        </section>

        <!-- PROFILE EDIT -->
        <section id="profile-edit" class="form-section">
          <h2>Rediger profil</h2>

          <form onsubmit="handleProfileUpdate(event)">
            <div
              class="avatar-upload-container"
              onclick="document.getElementById('avatar-input').click()"
            >
              <img
                id="edit-avatar-preview"
                src="default-avatar.png"
                alt="Preview"
              />
              <div class="avatar-overlay">
                <span class="material-symbols-outlined">photo_camera</span>
              </div>

              <input
                type="file"
                name="AvatarFile"
                id="avatar-input"
                accept="image/*"
                hidden
                onchange="previewImage(this)"
              />
            </div>

            <p class="hint-text">Trykk på bildet for å endre</p>

            <div class="input-group">
              <label for="edit-firstname">Fornavn</label>
              <input
                type="text"
                name="FirstName"
                id="edit-firstname"
                placeholder="Ola"
                autocomplete="given-name"
              />
            </div>

            <div class="input-group">
              <label for="edit-lastname">Etternavn</label>
              <input
                type="text"
                name="LastName"
                id="edit-lastname"
                placeholder="Nordmann"
                autocomplete="family-name"
              />
            </div>

            <div class="input-group">
              <label for="edit-age">Alder</label>
              <input
                type="number"
                name="Age"
                id="edit-age"
                placeholder="25"
                min="0"
                required
              />
            </div>

            <div class="input-group">
              <label for="edit-gender">Kjønn</label>
              <input
                type="text"
                name="Gender"
                id="edit-gender"
                placeholder="Mann / Kvinne / Annet"
                required
              />
            </div>

            <div class="input-group">
              <label for="edit-hobby">Hobby</label>
              <input
                type="text"
                name="Hobby"
                id="edit-hobby"
                placeholder="Fotball"
                required
              />
            </div>

            <div class="input-group">
              <label for="edit-birthplace">Fødested</label>
              <input
                type="text"
                name="MyPlaceOfBirth"
                id="edit-birthplace"
                placeholder="Oslo"
                required
              />
            </div>

            <div class="button-row">
              <button
                type="button"
                class="outline-btn"
                onclick="showSection('profile-view')"
              >
                Avbryt
              </button>
              <button type="submit" class="primary-btn">Lagre endringer</button>
            </div>
          </form>
        </section>

        <!-- CHANGE PASSWORD (LOGGED IN) -->
        <section id="change-password" class="form-section">
          <h2>Endre passord</h2>

          <form onsubmit="handleChangePasswordLoggedIn(event)">
            <div class="input-group">
              <span class="material-symbols-outlined input-icon">lock</span>
              <input
                type="password"
                id="current-password"
                required
                placeholder="Nåværende passord"
                autocomplete="current-password"
              />
            </div>

            <div class="input-group">
              <span class="material-symbols-outlined input-icon">lock</span>
              <input
                type="password"
                id="new-password"
                required
                placeholder="Nytt passord"
                autocomplete="new-password"
                minlength="6"
              />
            </div>

            <div class="input-group">
              <span class="material-symbols-outlined input-icon">lock</span>
              <input
                type="password"
                id="confirm-password"
                required
                placeholder="Gjenta nytt passord"
                autocomplete="new-password"
                minlength="6"
              />
            </div>

            <div class="button-row">
              <button
                type="button"
                class="outline-btn"
                onclick="showSection('profile-view')"
              >
                Avbryt
              </button>
              <button type="submit" class="primary-btn">Bytt passord</button>
            </div>
          </form>

          <div class="toggle-links" style="margin-top: 10px">
            <p style="text-align: center">
              Tips: bruk minst 8 tegn og bland bokstaver + tall.
            </p>
          </div>
        </section>
      </div>

      <noscript>
        <p style="margin-top: 16px; text-align: center">
          Denne siden krever JavaScript for å fungere.
        </p>
      </noscript>
    </main>

    <script>
      const LAST_EMAIL_KEY = "last_email";
      let initialRenderDone = false;

      function endInitialRender() {
        if (initialRenderDone) return;
        initialRenderDone = true;
        document.documentElement.classList.remove("js-loading");
      }

      function showSection(id) {
        document.querySelectorAll(".form-section").forEach((s) => {
          s.classList.remove("active");
          s.style.display = "none";
        });

        const target = document.getElementById(id);
        if (target) {
          target.style.display = "flex";
          setTimeout(() => target.classList.add("active"), 10);
        }

        endInitialRender();
      }

      function getCurrentEmail() {
        return (localStorage.getItem(LAST_EMAIL_KEY) || "")
          .trim()
          .toLowerCase();
      }

      function setAvatarEverywhere(src) {
        if (!src) return;
        const view = document.getElementById("view-avatar");
        const edit = document.getElementById("edit-avatar-preview");
        if (view) view.src = src;
        if (edit) edit.src = src;
      }

      function previewImage(input) {
        if (input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = function (e) {
            document.getElementById("edit-avatar-preview").src =
              e.target.result;
          };
          reader.readAsDataURL(input.files[0]);
        }
      }

      // ---- helper: prefill public change password email from login form
      function prefillEmailToPublicChangePassword() {
        const loginEmailInput = document.querySelector(
          "#login input[name='email']",
        );
        const email = (
          loginEmailInput?.value ||
          getCurrentEmail() ||
          ""
        ).trim();
        const cpEmail = document.getElementById("cp-email");
        if (cpEmail && email) cpEmail.value = email;

        showSection("change-password-public");
      }

      async function handleAuth(event, url, type) {
        event.preventDefault();

        const formData = new FormData(event.target);
        const data = Object.fromEntries(formData.entries());

        if (data.email) localStorage.setItem(LAST_EMAIL_KEY, data.email);

        try {
          const response = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });

          if (!response.ok) {
            const errorText = await response.text().catch(() => "Ukjent feil");
            alert("Feil: " + errorText);
            return;
          }

          if (type === "register") {
            await performAutoLogin(data.email, data.password);
          } else {
            const result = await response.json();
            processLoginSuccess(result);
          }
        } catch (e) {
          console.error(e);
          alert("Kunne ikke koble til serveren.");
        }
      }

      async function performAutoLogin(email, password) {
        try {
          const response = await fetch("/Auth/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password }),
          });

          if (response.ok) {
            const result = await response.json();
            processLoginSuccess(result);
          } else {
            alert("Konto opprettet! Vennligst logg inn.");
            showSection("login");
          }
        } catch {
          showSection("login");
        }
      }

      function processLoginSuccess(result) {
        const token = result.token || result.Token;
        if (token) {
          localStorage.setItem("token", token);
          loadProfileData();
        }
      }

      async function loadProfileData() {
        const token = localStorage.getItem("token");
        if (!token) {
          showSection("login");
          return;
        }

        try {
          const response = await fetch("/api/Profile", {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (response.ok) {
            const profile = await response.json();

            document.getElementById("view-fullname").innerText =
              `${profile.firstName || ""} ${profile.lastName || ""}`.trim() ||
              "Ukjent Bruker";

            const serverAvatar = profile.avatarUrl || "";
            if (serverAvatar) {
              const busted =
                serverAvatar +
                (serverAvatar.includes("?") ? "&" : "?") +
                "v=" +
                Date.now();
              setAvatarEverywhere(busted);
            } else {
              setAvatarEverywhere("default-avatar.png");
            }

            document.getElementById("edit-firstname").value =
              profile.firstName || "";
            document.getElementById("edit-lastname").value =
              profile.lastName || "";
            document.getElementById("edit-age").value =
              profile.age ?? "";
            document.getElementById("edit-gender").value =
              profile.gender || "";
            document.getElementById("edit-hobby").value =
              profile.hobby || "";
            document.getElementById("edit-birthplace").value =
              profile.myPlaceOfBirth || "";

            document.getElementById("view-age").innerText =
              profile.age ?? "—";
            document.getElementById("view-gender").innerText =
              profile.gender || "—";
            document.getElementById("view-hobby").innerText =
              profile.hobby || "—";
            document.getElementById("view-birthplace").innerText =
              profile.myPlaceOfBirth || "—";

            showSection("profile-view");
          } else if (response.status === 404) {
            showSection("profile-edit");
          } else {
            logout();
          }
        } catch (error) {
          console.error(error);
          showSection("login");
        }
      }

      async function handleProfileUpdate(event) {
        event.preventDefault();

        const token = localStorage.getItem("token");
        const formData = new FormData(event.target);

        const btn = event.target.querySelector("button[type='submit']");
        const originalText = btn.innerText;

        btn.innerText = "Lagrer...";
        btn.disabled = true;

        try {
          const response = await fetch("/api/Profile", {
            method: "POST",
            headers: { Authorization: `Bearer ${token}` },
            body: formData,
          });

          if (response.ok) {
            await loadProfileData();
          } else {
            const err = await response.text().catch(() => "");
            alert(`Kunne ikke lagre profil. (${response.status}) ${err}`);
          }
        } catch {
          alert("Serverfeil.");
        } finally {
          btn.innerText = originalText;
          btn.disabled = false;
        }
      }

      // ---- CHANGE PASSWORD (PUBLIC, NO TOKEN REQUIRED)
      async function handleChangePasswordPublic(event) {
        event.preventDefault();

        const email = document.getElementById("cp-email").value.trim();
        const currentPassword = document.getElementById(
          "cp-current-password",
        ).value;
        const newPassword = document.getElementById("cp-new-password").value;
        const confirmPassword = document.getElementById(
          "cp-confirm-password",
        ).value;

        if (newPassword !== confirmPassword) {
          alert("Passordene er ikke like.");
          return;
        }

        const btn = event.target.querySelector("button[type='submit']");
        const originalText = btn.innerText;
        btn.innerText = "Bytter...";
        btn.disabled = true;

        try {
          const resp = await fetch("/Auth/change-password", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              Email: email,
              CurrentPassword: currentPassword,
              NewPassword: newPassword,
            }),
          });

          if (resp.ok) {
            alert("Passord endret! Du kan logge inn nå.");
            // keep email for login convenience
            localStorage.setItem(LAST_EMAIL_KEY, email);

            // clear fields
            document.getElementById("cp-current-password").value = "";
            document.getElementById("cp-new-password").value = "";
            document.getElementById("cp-confirm-password").value = "";

            showSection("login");
            return;
          }

          const err = await resp.text().catch(() => "");
          alert(`Kunne ikke endre passord. (${resp.status}) ${err}`.trim());
        } catch {
          alert("Serverfeil.");
        } finally {
          btn.innerText = originalText;
          btn.disabled = false;
        }
      }

      // ---- CHANGE PASSWORD (LOGGED IN)
      async function handleChangePasswordLoggedIn(event) {
        event.preventDefault();

        const email = getCurrentEmail();
        const currentPassword =
          document.getElementById("current-password").value;
        const newPassword = document.getElementById("new-password").value;
        const confirmPassword =
          document.getElementById("confirm-password").value;

        if (!email) {
          alert("Fant ikke e-post. Logg inn på nytt.");
          logout();
          return;
        }

        if (newPassword !== confirmPassword) {
          alert("Passordene er ikke like.");
          return;
        }

        const btn = event.target.querySelector("button[type='submit']");
        const originalText = btn.innerText;
        btn.innerText = "Bytter...";
        btn.disabled = true;

        try {
          const token = localStorage.getItem("token"); // optional
          const headers = { "Content-Type": "application/json" };
          if (token) headers.Authorization = `Bearer ${token}`;

          const resp = await fetch("/Auth/change-password", {
            method: "POST",
            headers,
            body: JSON.stringify({
              Email: email,
              CurrentPassword: currentPassword,
              NewPassword: newPassword,
            }),
          });

          if (resp.ok) {
            alert("Passord endret!");
            document.getElementById("current-password").value = "";
            document.getElementById("new-password").value = "";
            document.getElementById("confirm-password").value = "";
            showSection("profile-view");
            return;
          }

          const err = await resp.text().catch(() => "");
          alert(`Kunne ikke endre passord. (${resp.status}) ${err}`.trim());
        } catch {
          alert("Serverfeil.");
        } finally {
          btn.innerText = originalText;
          btn.disabled = false;
        }
      }

      function logout() {
        localStorage.removeItem("token");
        setAvatarEverywhere("default-avatar.png");
        showSection("login");
      }

      window.onload = () => {
        if (localStorage.getItem("token")) {
          loadProfileData();
        } else {
          showSection("login");
        }
      };
    </script>
  </body>
</html>
